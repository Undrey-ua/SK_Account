<!DOCTYPE html>

<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–∏—Å—Ç–µ–º–∞ –æ–±–ª—ñ–∫—É —Å—Ç–µ–Ω–¥—ñ–≤ —Ç–∞ –ø—Ä–æ–¥–∞–∂—ñ–≤</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .tabs {
            display: flex;
            background: #ecf0f1;
            border-bottom: 3px solid #3498db;
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #bdc3c7;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
        }
        
        .tab:hover:not(.active) {
            background: #95a5a6;
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 25px;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .manager-info {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .manager-details h2 {
            margin: 0;
            font-size: 1.8em;
        }
        
        .manager-stats {
            display: flex;
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            display: block;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .goals-section {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .goal-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }
        
        .goal-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            background: #ecf0f1;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .data-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            border-bottom: 2px solid #34495e;
        }
        
        .data-table td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
            transition: background 0.3s ease;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .shop-name {
            text-align: left !important;
            font-weight: 600;
            color: #2c3e50;
            background: #f8f9fa;
            border-left: 4px solid #3498db;
        }
        
        .address-cell {
            text-align: left !important;
            font-size: 11px;
            color: #7f8c8d;
            max-width: 200px;
        }
        
        .brand-cell {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .sales-cell {
            font-weight: bold;
            color: #27ae60;
        }
        
        .comment-cell {
            text-align: left !important;
            font-size: 11px;
            color: #7f8c8d;
            max-width: 200px;
        }
        
        .total-row {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            font-weight: bold;
        }
        
        .total-row td {
            border-bottom: none;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .analytics-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-top: 4px solid #3498db;
        }
        
        .analytics-card h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.3em;
        }
        
        .chart-container {
            height: 200px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-value {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .edit-btn {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease;
        }
        
        .edit-btn:hover {
            transform: translateY(-2px);
        }
        
        .add-btn {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px 0;
            transition: transform 0.2s ease;
        }
        
        .add-btn:hover {
            transform: translateY(-2px);
        }
        
        .region-badge {
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .region-badge.kyiv { background: #3498db; }
        .region-badge.dnipro { background: #e74c3c; }
        .region-badge.west { background: #f39c12; }
        
        .brand-distribution {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .brand-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .brand-count {
            font-size: 1.5em;
            font-weight: bold;
            color: #3498db;
        }
        
        .brand-name {
            font-size: 0.9em;
            color: #7f8c8d;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #ecf0f1;
        }
        
        .comparison-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
        }
        
        .comparison-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .performance-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .performance-high { background: #2ecc71; }
        .performance-medium { background: #f39c12; }
        .performance-low { background: #e74c3c; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè™ –°–∏—Å—Ç–µ–º–∞ –æ–±–ª—ñ–∫—É —Å—Ç–µ–Ω–¥—ñ–≤ —Ç–∞ –ø—Ä–æ–¥–∞–∂—ñ–≤</h1>
            <p>–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞ —Ä–æ–±–æ—Ç–∏ –∑ —Ç–æ—Ä–≥–æ–≤–∏–º–∏ —Ç–æ—á–∫–∞–º–∏</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('andrii')">üë®‚Äçüíº –ê–Ω–¥—Ä—ñ–π (–ö–∏—ó–≤)</button>
            <button class="tab" onclick="showTab('roman')">üë®‚Äçüíº –†–æ–º–∞–Ω (–î–Ω—ñ–ø—Ä–æ)</button>
            <button class="tab" onclick="showTab('pavlo')">üë®‚Äçüíº –ü–∞–≤–ª–æ (–ó–∞—Ö—ñ–¥)</button>
            <button class="tab" onclick="showTab('analytics')">üìä –ü–æ—Ä—ñ–≤–Ω—è–ª—å–Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞</button>
            <button class="tab" onclick="showTab('plans')">üéØ –¶—ñ–ª—ñ —Ç–∞ –ø–ª–∞–Ω–∏</button>
        </div>
        
        <div id="andrii" class="tab-content active">
            <div class="manager-info">
                <div class="manager-details">
                    <h2>üë®‚Äçüíº –ê–Ω–¥—Ä—ñ–π –í–æ–≤–Ω—è–Ω–∫–æ</h2>
                    <p><span class="region-badge kyiv">–ö–∏—ó–≤ —Ç–∞ –æ–±–ª–∞—Å—Ç—å</span></p>
                </div>
                <div class="manager-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="andrii-sales">0</span>
                        <span class="stat-label">–ü—Ä–æ–¥–∞–∂—ñ (–∫–≤ –º)</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="andrii-avg">0</span>
                        <span class="stat-label">–°–µ—Ä–µ–¥–Ω—è –¢–¢</span>
                    </div>
                </div>
            </div>
            
            <div class="goals-section">
                <h3>üéØ –¶—ñ–ª—ñ –Ω–∞ –ø–æ—Ç–æ—á–Ω–∏–π –º—ñ—Å—è—Ü—å</h3>
                <div class="goals-grid" id="andrii-goals"></div>
            </div>
            
            <button class="add-btn" onclick="openAddSaleForm('andrii')">–î–æ–¥–∞—Ç–∏ –ø—Ä–æ–¥–∞–∂</button>
            <table class="data-table" id="andrii-table">
                <thead>
                    <tr>
                        <th>–¢–æ—Ä–≥–æ–≤–∞ —Ç–æ—á–∫–∞</th>
                        <th>–°—Ç–µ–Ω–¥</th>
                        <th>–ü—Ä–æ–¥–∞–∂—ñ (–∫–≤ –º)</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–ö–æ–º–µ–Ω—Ç–∞—Ä</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <h4>–û–±–ª—ñ–∫ —Å—Ç–µ–Ω–¥—ñ–≤ (–º–∞—Ç—Ä–∏—Ü—è)</h4>
            <div id="andrii-stands-matrix"></div>
            <h4>–ü—Ä–æ–¥–∞–∂—ñ (–º–∞—Ç—Ä–∏—Ü—è)</h4>
            <div class="filter-row">
              <label>–ú—ñ—Å—è—Ü—å:
                <select class="month-select" data-manager="andrii"></select>
              </label>
              <label>–†—ñ–∫:
                <select class="year-select" data-manager="andrii"></select>
              </label>
            </div>
            <div id="andrii-sales-matrix"></div>
        </div>
        
        <div id="roman" class="tab-content">
            <div class="manager-info">
                <div class="manager-details">
                    <h2>üë®‚Äçüíº –†–æ–º–∞–Ω</h2>
                    <p><span class="region-badge dnipro">–î–Ω—ñ–ø—Ä–æ —Ç–∞ –æ–±–ª–∞—Å—Ç—å</span></p>
                </div>
                <div class="manager-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="roman-sales">0</span>
                        <span class="stat-label">–ü—Ä–æ–¥–∞–∂—ñ (–∫–≤ –º)</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="roman-avg">0</span>
                        <span class="stat-label">–°–µ—Ä–µ–¥–Ω—è –¢–¢</span>
                    </div>
                </div>
            </div>
            <div class="goals-section">
                <h3>üéØ –¶—ñ–ª—ñ –Ω–∞ –ø–æ—Ç–æ—á–Ω–∏–π –º—ñ—Å—è—Ü—å</h3>
                <div class="goals-grid" id="roman-goals"></div>
            </div>
            <button class="add-btn" onclick="openAddSaleForm('roman')">–î–æ–¥–∞—Ç–∏ –ø—Ä–æ–¥–∞–∂</button>
            <table class="data-table" id="roman-table">
                <thead>
                    <tr>
                        <th>–¢–æ—Ä–≥–æ–≤–∞ —Ç–æ—á–∫–∞</th>
                        <th>–°—Ç–µ–Ω–¥</th>
                        <th>–ü—Ä–æ–¥–∞–∂—ñ (–∫–≤ –º)</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–ö–æ–º–µ–Ω—Ç–∞—Ä</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <h4>–û–±–ª—ñ–∫ —Å—Ç–µ–Ω–¥—ñ–≤ (–º–∞—Ç—Ä–∏—Ü—è)</h4>
            <div id="roman-stands-matrix"></div>
            <h4>–ü—Ä–æ–¥–∞–∂—ñ (–º–∞—Ç—Ä–∏—Ü—è)</h4>
            <div class="filter-row">
              <label>–ú—ñ—Å—è—Ü—å:
                <select class="month-select" data-manager="roman"></select>
              </label>
              <label>–†—ñ–∫:
                <select class="year-select" data-manager="roman"></select>
              </label>
            </div>
            <div id="roman-sales-matrix"></div>
        </div>
        
        <div id="pavlo" class="tab-content">
            <div class="manager-info">
                <div class="manager-details">
                    <h2>üë®‚Äçüíº –ü–∞–≤–ª–æ</h2>
                    <p><span class="region-badge west">–ó–∞—Ö—ñ–¥–Ω–∞ –£–∫—Ä–∞—ó–Ω–∞</span></p>
                </div>
                <div class="manager-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="pavlo-sales">0</span>
                        <span class="stat-label">–ü—Ä–æ–¥–∞–∂—ñ (–∫–≤ –º)</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="pavlo-avg">0</span>
                        <span class="stat-label">–°–µ—Ä–µ–¥–Ω—è –¢–¢</span>
                    </div>
                </div>
            </div>
            <div class="goals-section">
                <h3>üéØ –¶—ñ–ª—ñ –Ω–∞ –ø–æ—Ç–æ—á–Ω–∏–π –º—ñ—Å—è—Ü—å</h3>
                <div class="goals-grid" id="pavlo-goals"></div>
            </div>
            <button class="add-btn" onclick="openAddSaleForm('pavlo')">–î–æ–¥–∞—Ç–∏ –ø—Ä–æ–¥–∞–∂</button>
            <table class="data-table" id="pavlo-table">
                <thead>
                    <tr>
                        <th>–¢–æ—Ä–≥–æ–≤–∞ —Ç–æ—á–∫–∞</th>
                        <th>–°—Ç–µ–Ω–¥</th>
                        <th>–ü—Ä–æ–¥–∞–∂—ñ (–∫–≤ –º)</th>
                        <th>–î–∞—Ç–∞</th>
                        <th>–ö–æ–º–µ–Ω—Ç–∞—Ä</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <h4>–û–±–ª—ñ–∫ —Å—Ç–µ–Ω–¥—ñ–≤ (–º–∞—Ç—Ä–∏—Ü—è)</h4>
            <div id="pavlo-stands-matrix"></div>
            <h4>–ü—Ä–æ–¥–∞–∂—ñ (–º–∞—Ç—Ä–∏—Ü—è)</h4>
            <div class="filter-row">
              <label>–ú—ñ—Å—è—Ü—å:
                <select class="month-select" data-manager="pavlo"></select>
              </label>
              <label>–†—ñ–∫:
                <select class="year-select" data-manager="pavlo"></select>
              </label>
            </div>
            <div id="pavlo-sales-matrix"></div>
        </div>
        
        <div id="analytics" class="tab-content">
            <h2>üìä –ü–æ—Ä—ñ–≤–Ω—è–ª—å–Ω–∞ –∞–Ω–∞–ª—ñ—Ç–∏–∫–∞</h2>
            <div id="analytics-content"></div>
        </div>
        
        <div id="plans" class="tab-content">
            <h2>üéØ –¶—ñ–ª—ñ —Ç–∞ –ø–ª–∞–Ω–∏</h2>
            <div id="plans-content"></div>
        </div>
        
        <div id="modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); align-items:center; justify-content:center; z-index:1000;">
            <div style="background:white; padding:30px; border-radius:10px; min-width:300px; max-width:90vw;">
                <h3 id="modal-title">–î–æ–¥–∞—Ç–∏ –ø—Ä–æ–¥–∞–∂</h3>
                <form id="modal-form">
                    <div>
                        <label>–¢–æ—Ä–≥–æ–≤–∞ —Ç–æ—á–∫–∞:<br>
                            <select name="shop" id="modal-shop-select" required></select>
                        </label>
                    </div>
                    <div>
                        <label>–°—Ç–µ–Ω–¥:<br>
                            <select name="stand" id="modal-stand-select" required></select>
                        </label>
                    </div>
                    <div>
                        <label>–ü—Ä–æ–¥–∞–∂—ñ (–∫–≤ –º):<br>
                            <input name="sales" type="number" step="0.001" required>
                        </label>
                    </div>
                    <div>
                        <label>–î–∞—Ç–∞:<br>
                            <input name="date" type="date" required>
                        </label>
                    </div>
                    <div>
                        <label>–ö–æ–º–µ–Ω—Ç–∞—Ä:<br>
                            <input name="comment">
                        </label>
                    </div>
                    <div style="margin-top:15px; text-align:right;">
                        <button type="button" onclick="closeModal()">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                        <button type="submit">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzd81nrC9ZPq-sz56rC7rGxnzJ4d3s_w543JeVSfQIcJYa73gAlWRhCaMi5vJ6oxieT/exec';

    const managerSheets = {
        andrii: {
            sales: '–ü—Ä–æ–¥–∞–∂—ñ –ß–µ—Ä–≤–µ–Ω—å (–ê–Ω–¥—Ä—ñ–π)',
            stands: '–û–±–ª—ñ–∫ —Å—Ç–µ–Ω–¥—ñ–≤(–ê–Ω–¥—Ä—ñ–π)',
            goals: '–ü–ª–∞–Ω–∏',
            name: '–ê–Ω–¥—Ä—ñ–π'
        },
        roman: {
            sales: '–ü—Ä–æ–¥–∞–∂—ñ –ß–µ—Ä–≤–µ–Ω—å (–†–æ–º–∞–Ω)',
            stands: '–û–±–ª—ñ–∫ —Å—Ç–µ–Ω–¥—ñ–≤(–†–æ–º–∞–Ω)',
            goals: '–ü–ª–∞–Ω–∏',
            name: '–†–æ–º–∞–Ω'
        },
        pavlo: {
            sales: '–ü—Ä–æ–¥–∞–∂—ñ –ß–µ—Ä–≤–µ–Ω—å (–ü–∞–≤–ª–æ)',
            stands: '–û–±–ª—ñ–∫ —Å—Ç–µ–Ω–¥—ñ–≤(–ü–∞–≤–ª–æ)',
            goals: '–ü–ª–∞–Ω–∏',
            name: '–ü–∞–≤–ª–æ'
        }
    };

    async function fetchSheet(sheet) {
        const url = `${API_URL}?sheet=${encodeURIComponent(sheet)}`;
        const res = await fetch(url);
        return await res.json();
    }

    function parseStandsMatrix(data) {
        if (!data.length) return [];
        const columns = Object.keys(data[0]);
        const idxStart = columns.indexOf("–ê–¥—Ä–µ—Å–∞") + 1;
        let idxEnd = columns.indexOf("–ö–æ–º–µ–Ω—Ç–∞—Ä");
        if (idxEnd === -1) idxEnd = columns.length;
        const standColumns = columns.slice(idxStart, idxEnd);

        const result = [];
        data.forEach(row => {
            const tt = (row["–ù–∞–∑–≤–∞ –¢–¢"] || "").toLowerCase();
            if (
                !tt ||
                ["–º–µ–Ω–µ–¥–∂–µ—Ä", "–º—ñ—Å—è—Ü—å", "—Ç–æ—Ä–≥–æ–≤–∞ —Ç–æ—á–∫–∞", "—Å—Ç–µ–Ω–¥", "–ø—Ä–æ–¥–∞–∂—ñ (–º¬≤)", "–¥–∞—Ç–∞"].includes(tt)
            ) return;

            standColumns.forEach(stand => {
                const value = row[stand];
                if (value && value.toString().trim() !== '0' && value.toString().trim() !== '-' && value.toString().trim() !== '') {
                    result.push({
                        "–°—Ç–µ–Ω–¥": stand,
                        "–¢–¢": row["–ù–∞–∑–≤–∞ –¢–¢"],
                        "–ê–¥—Ä–µ—Å–∞": row["–ê–¥—Ä–µ—Å–∞"],
                        "–ö—ñ–ª—å–∫—ñ—Å—Ç—å": value,
                        "–ö–æ–º–µ–Ω—Ç–∞—Ä": row["–ö–æ–º–µ–Ω—Ç–∞—Ä"] || ""
                    });
                }
            });
        });
        return result;
    }

    function renderStandsMatrix(manager, data) {
        if (!data.length) return;
        const columns = Object.keys(data[0]);
        const idxStart = columns.indexOf("–ê–¥—Ä–µ—Å–∞") + 1;
        let idxEnd = columns.indexOf("–ö–æ–º–µ–Ω—Ç–∞—Ä");
        if (idxEnd === -1) idxEnd = columns.length;
        const standColumns = columns.slice(idxStart, idxEnd);

        // –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ —Å—É–º –ø–æ –∫–æ–∂–Ω–æ–º—É —Å—Ç–µ–Ω–¥—É
        const totals = {};
        standColumns.forEach(col => totals[col] = 0);

        let rowsHtml = '';
        data.forEach(row => {
            const tt = (row["–ù–∞–∑–≤–∞ –¢–¢"] || "").toLowerCase();
            if (
                !tt ||
                ["–º–µ–Ω–µ–¥–∂–µ—Ä", "–º—ñ—Å—è—Ü—å", "—Ç–æ—Ä–≥–æ–≤–∞ —Ç–æ—á–∫–∞", "—Å—Ç–µ–Ω–¥", "–ø—Ä–æ–¥–∞–∂—ñ (–º¬≤)", "–¥–∞—Ç–∞"].includes(tt)
            ) return;
            rowsHtml += `<tr><td>${row["–ù–∞–∑–≤–∞ –¢–¢"] || ""}</td><td>${row["–ê–¥—Ä–µ—Å–∞"] || ""}</td>`;
            standColumns.forEach(col => {
                const val = Number(row[col]) || 0;
                totals[col] += val;
                rowsHtml += `<td>${row[col] || ""}</td>`;
            });
            rowsHtml += `<td>${row["–ö–æ–º–µ–Ω—Ç–∞—Ä"] || ""}</td></tr>`;
        });

        // –§–æ—Ä–º—É—î–º–æ –ø—ñ–¥—Å—É–º–∫–æ–≤–∏–π —Ä—è–¥–æ–∫
        let totalsHtml = '<tr style="font-weight:bold;background:#e3f6ff;"><td colspan="2">–í—Å—å–æ–≥–æ</td>';
        standColumns.forEach(col => totalsHtml += `<td>${totals[col]}</td>`);
        totalsHtml += '<td></td></tr>';

        // –§–æ—Ä–º—É—î–º–æ –≤—Å—é —Ç–∞–±–ª–∏—Ü—é
        let html = '<table class="data-table"><thead><tr>';
        html += '<th>–¢–æ—Ä–≥–æ–≤–∞ —Ç–æ—á–∫–∞</th><th>–ê–¥—Ä–µ—Å–∞</th>';
        standColumns.forEach(col => html += `<th>${col}</th>`);
        html += '<th>–ö–æ–º–µ–Ω—Ç–∞—Ä</th></tr>';
        html += totalsHtml;
        html += '</thead><tbody>';
        html += rowsHtml;
        html += '</tbody></table>';

        document.getElementById(`${manager}-stands-matrix`).innerHTML = html;
    }

    function renderSalesMatrix(manager, data) {
        if (!data.length) return;
        console.log('–ö–ª—é—á—ñ –∫–æ–ª–æ–Ω–æ–∫ —É data[0]:', Object.keys(data[0]));
        console.log('–ü–µ—Ä—à–∏–π —Ä—è–¥–æ–∫:', data[0]);
        const columns = Object.keys(data[0]);
        // –í–∏–∑–Ω–∞—á–∞—î–º–æ —ñ–Ω–¥–µ–∫—Å–∏
        const idxStart = columns.indexOf("Tarkett: Express");
        let idxEnd = columns.indexOf("–ù–æ–º–µ—Ä–∏ –Ω–∞–∫–ª–∞–¥–Ω–∏—Ö");
        if (idxEnd === -1) idxEnd = columns.length - 1;
        const standColumns = columns.slice(idxStart, idxEnd);

        // –ü—ñ–¥—Ä–∞—Ö—É–Ω–æ–∫ —Å—É–º –ø–æ –∫–æ–∂–Ω—ñ–π –∫–æ–ª–æ–Ω—Ü—ñ (–≤–∫–ª—é—á–∞—é—á–∏ "–í—Å—å–æ–≥–æ, –∫–≤ –º")
        const totals = {};
        ["–í—Å—å–æ–≥–æ, –∫–≤ –º", ...standColumns].forEach(col => totals[col] = 0);

        let rowsHtml = '';
        data.forEach(row => {
            const tt = (row["–ù–∞–∑–≤–∞ –¢–¢"] || "").toLowerCase().trim();
            if (!tt) return;
            rowsHtml += `<tr><td>${row["–ù–∞–∑–≤–∞ –¢–¢"] || ""}</td>`;
            rowsHtml += `<td>${row["–í—Å—å–æ–≥–æ, –∫–≤ –º"] || ""}</td>`;
            standColumns.forEach(col => {
                const val = Number(row[col]) || 0;
                totals[col] += val;
                rowsHtml += `<td>${row[col] || ""}</td>`;
            });
            rowsHtml += `<td>${row["–ù–æ–º–µ—Ä–∏ –Ω–∞–∫–ª–∞–¥–Ω–∏—Ö"] || ""}</td></tr>`;
            totals["–í—Å—å–æ–≥–æ, –∫–≤ –º"] += Number(row["–í—Å—å–æ–≥–æ, –∫–≤ –º"]) || 0;
        });

        // –ü—ñ–¥—Å—É–º–∫–æ–≤–∏–π —Ä—è–¥–æ–∫
        let totalsHtml = '<tr style="font-weight:bold;background:#e3f6ff;"><td>–í—Å—å–æ–≥–æ</td>';
        totalsHtml += `<td>${totals["–í—Å—å–æ–≥–æ, –∫–≤ –º"]}</td>`;
        standColumns.forEach(col => totalsHtml += `<td>${totals[col]}</td>`);
        totalsHtml += '<td></td></tr>';

        // –§–æ—Ä–º—É—î–º–æ –≤—Å—é —Ç–∞–±–ª–∏—Ü—é
        let html = '<table class="data-table"><thead><tr>';
        html += '<th>–ù–∞–∑–≤–∞ –¢–¢</th><th>–í—Å—å–æ–≥–æ, –∫–≤ –º</th>';
        standColumns.forEach(col => html += `<th>${col}</th>`);
        html += '<th>–ù–æ–º–µ—Ä–∏ –Ω–∞–∫–ª–∞–¥–Ω–∏—Ö</th></tr>';
        html += totalsHtml;
        html += '</thead><tbody>';
        html += rowsHtml;
        html += '</tbody></table>';

        document.getElementById(`${manager}-sales-matrix`).innerHTML = html;
    }

    const months = [
      "–°—ñ—á–µ–Ω—å", "–õ—é—Ç–∏–π", "–ë–µ—Ä–µ–∑–µ–Ω—å", "–ö–≤—ñ—Ç–µ–Ω—å", "–¢—Ä–∞–≤–µ–Ω—å", "–ß–µ—Ä–≤–µ–Ω—å",
      "–õ–∏–ø–µ–Ω—å", "–°–µ—Ä–ø–µ–Ω—å", "–í–µ—Ä–µ—Å–µ–Ω—å", "–ñ–æ–≤—Ç–µ–Ω—å", "–õ–∏—Å—Ç–æ–ø–∞–¥", "–ì—Ä—É–¥–µ–Ω—å"
    ];

    function fillMonthYearSelectors() {
      ['andrii', 'roman', 'pavlo'].forEach(manager => {
        const monthSel = document.querySelector(`.month-select[data-manager="${manager}"]`);
        const yearSel = document.querySelector(`.year-select[data-manager="${manager}"]`);
        if (!monthSel || !yearSel) return;
        monthSel.innerHTML = months.map((m, i) =>
          `<option value="${i+1}" ${i+1===new Date().getMonth()+1 ? 'selected' : ''}>${m}</option>`
        ).join('');
        const thisYear = new Date().getFullYear();
        yearSel.innerHTML = '';
        for (let y = thisYear; y >= thisYear-5; y--) {
          yearSel.innerHTML += `<option value="${y}" ${y===thisYear ? 'selected' : ''}>${y}</option>`;
        }
      });
    }
    fillMonthYearSelectors();

    function filterSalesByMonth(data, month, year) {
      return data.filter(row => {
        if (!row['–î–∞—Ç–∞']) return false;
        let d;
        if (row['–î–∞—Ç–∞'].includes('.')) {
          // DD.MM.YYYY
          const [day, mon, yr] = row['–î–∞—Ç–∞'].split('.');
          d = new Date(`${yr}-${mon}-${day}`);
        } else {
          d = new Date(row['–î–∞—Ç–∞']);
        }
        return d.getMonth() + 1 === month && d.getFullYear() === year;
      });
    }

    document.querySelectorAll('.month-select, .year-select').forEach(sel => {
      sel.addEventListener('change', function() {
        const manager = this.getAttribute('data-manager');
        renderManagerTab(manager, true); // true = –æ–Ω–æ–≤–∏—Ç–∏ —Ç—ñ–ª—å–∫–∏ –ø—Ä–æ–¥–∞–∂—ñ
      });
    });

    function renderManagerTab(manager, onlySales = false) {
      const sheets = managerSheets[manager];
      // –í–∏—Ç—è–≥—É—î–º–æ –æ–±—Ä–∞–Ω–∏–π –º—ñ—Å—è—Ü—å/—Ä—ñ–∫
      const monthSel = document.querySelector(`.month-select[data-manager="${manager}"]`);
      const yearSel = document.querySelector(`.year-select[data-manager="${manager}"]`);
      const month = monthSel ? Number(monthSel.value) : (new Date().getMonth() + 1);
      const year = yearSel ? Number(yearSel.value) : (new Date().getFullYear());

      fetchSheet(sheets.sales).then(data => {
        const filtered = filterSalesByMonth(data, month, year);
        const total = filtered.reduce((sum, row) => {
          const val = parseFloat((row['–í—Å—å–æ–≥–æ, –∫–≤ –º'] || row['–ü—Ä–æ–¥–∞–∂—ñ (–º¬≤)'] || '0').toString().replace(',', '.'));
          return sum + (isNaN(val) ? 0 : val);
        }, 0);
        const roundedTotal = total.toFixed(3);
        document.getElementById(`${manager}-sales`).textContent = roundedTotal;
        const avg = filtered.length ? (total / filtered.length) : 0;
        document.getElementById(`${manager}-avg`).textContent = avg.toLocaleString('uk-UA', {maximumFractionDigits: 3});
        // –¢–∞–±–ª–∏—Ü—è –ø—Ä–æ–¥–∞–∂—ñ–≤
        const tbody = document.querySelector(`#${manager}-table tbody`);
        tbody.innerHTML = '';
        filtered.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row['–ù–∞–∑–≤–∞ –¢–¢'] || row['–¢–æ—Ä–≥–æ–≤–∞ —Ç–æ—á–∫–∞'] || ''}</td>
            <td>${row['–°—Ç–µ–Ω–¥'] || ''}</td>
            <td>${row['–í—Å—å–æ–≥–æ, –∫–≤ –º'] || row['–ü—Ä–æ–¥–∞–∂—ñ (–º¬≤)'] || ''}</td>
            <td>${row['–î–∞—Ç–∞'] ? new Date(row['–î–∞—Ç–∞']).toLocaleDateString('uk-UA') : ''}</td>
            <td>${row['–ö–æ–º–µ–Ω—Ç–∞—Ä'] || ''}</td>
          `;
          tbody.appendChild(tr);
        });
        renderSalesMatrix(manager, filtered);
        console.log('filtered sales:', filtered);
      });

      if (!onlySales) {
        // –°—Ç–µ–Ω–¥–∏
        fetchSheet(sheets.stands).then(data => {
          renderStandsMatrix(manager, data);
        });
        // –¶—ñ–ª—ñ
        fetchSheet(sheets.goals).then(data => {
          const goals = data.filter(row => row['–ú–µ–Ω–µ–¥–∂–µ—Ä'] === sheets.name);
          const grid = document.getElementById(`${manager}-goals`);
          grid.innerHTML = '';
          goals.forEach(goal => {
            const div = document.createElement('div');
            div.className = 'goal-card';
            div.innerHTML = `
              <div class="goal-title">${goal['–¶—ñ–ª—å'] || '–ü—Ä–æ–¥–∞–∂—ñ'}</div>
              <div class="progress-bar"><div class="progress-fill" style="width:${goal['–í–∏–∫–æ–Ω–∞–Ω–Ω—è']||'0'}%">${goal['–í–∏–∫–æ–Ω–∞–Ω–Ω—è']||'0'}%</div></div>
              <div>${goal['–§–∞–∫—Ç']||'0'} / ${goal['–ü–ª–∞–Ω']||'0'}</div>
            `;
            grid.appendChild(div);
          });
        });
      }
    }

    function renderAllManagers() {
      renderManagerTab('andrii');
      renderManagerTab('roman');
      renderManagerTab('pavlo');
    }

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
    }

    // –ú–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ø—Ä–æ–¥–∞–∂—É
    async function openAddSaleForm(manager) {
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('modal-title').textContent = '–î–æ–¥–∞—Ç–∏ –ø—Ä–æ–¥–∞–∂';
        const form = document.getElementById('modal-form');

        // 1. –ü—ñ–¥—Ç—è–≥—É—î–º–æ —Ç–æ—Ä–≥–æ–≤—ñ —Ç–æ—á–∫–∏ —Ç–∞ —Å—Ç–µ–Ω–¥–∏
        const standsData = await fetchSheet(managerSheets[manager].stands);

        // –£–Ω—ñ–∫–∞–ª—å–Ω—ñ —Ç–æ—Ä–≥–æ–≤—ñ —Ç–æ—á–∫–∏
        const shops = Array.from(new Set(
          standsData
            .map(row => row['–ù–∞–∑–≤–∞ –¢–¢'])
            .filter(Boolean)
        ));

        // –£–Ω—ñ–∫–∞–ª—å–Ω—ñ —Å—Ç–µ–Ω–¥–∏ (–ø–æ –≤—Å—ñ—Ö –∫–æ–ª–æ–Ω–∫–∞—Ö –ø—ñ—Å–ª—è "–ê–¥—Ä–µ—Å–∞" —ñ –¥–æ "–ö–æ–º–µ–Ω—Ç–∞—Ä")
        const columns = standsData.length ? Object.keys(standsData[0]) : [];
        const idxStart = columns.indexOf("–ê–¥—Ä–µ—Å–∞") + 1;
        let idxEnd = columns.indexOf("–ö–æ–º–µ–Ω—Ç–∞—Ä");
        if (idxEnd === -1) idxEnd = columns.length;
        const standNames = columns.slice(idxStart, idxEnd);

        // –ó–∞–ø–æ–≤–Ω—é—î–º–æ —Å–µ–ª–µ–∫—Ç–æ—Ä–∏
        const shopSelect = document.getElementById('modal-shop-select');
        const standSelect = document.getElementById('modal-stand-select');
        console.log('shopSelect:', shopSelect, 'standSelect:', standSelect);
        shopSelect.innerHTML = shops.map(shop => `<option value="${shop}">${shop}</option>`).join('');

        standSelect.innerHTML = standNames.map(stand => `<option value="${stand}">${stand}</option>`).join('');

        console.log('shops:', shops);
        console.log('standNames:', standNames);

        // 2. –û–±—Ä–æ–±–∫–∞ —Å–∞–±–º—ñ—Ç—É
        form.onsubmit = async function(e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(form).entries());
            // –§–æ—Ä–º—É—î–º–æ –æ–±'—î–∫—Ç –¥–ª—è Google Sheets
            const row = {
                '–¢–æ—Ä–≥–æ–≤–∞ —Ç–æ—á–∫–∞': data.shop,
                '–°—Ç–µ–Ω–¥': data.stand,
                '–ü—Ä–æ–¥–∞–∂—ñ (–º¬≤)': data.sales,
                '–î–∞—Ç–∞': data.date,
                '–ö–æ–º–µ–Ω—Ç–∞—Ä': data.comment
            };
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({sheet: managerSheets[manager].sales, data: row}),
                headers: {'Content-Type': 'application/json'}
            });
            closeModal();
            renderManagerTab(manager);
        };
    }
    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }

    // –ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ (–∑–∞–≥–∞–ª—å–Ω–∞)
    function renderAnalytics() {
        // –ü–æ—Ä—ñ–≤–Ω—è–Ω–Ω—è –ø—Ä–æ–¥–∞–∂—ñ–≤ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞—Ö
        Promise.all([
            fetchSheet(managerSheets.andrii.sales),
            fetchSheet(managerSheets.roman.sales),
            fetchSheet(managerSheets.pavlo.sales)
        ]).then(([a, r, p]) => {
            const totalA = a.reduce((sum, row) => sum + parseFloat((row['–í—Å—å–æ–≥–æ, –∫–≤ –º'] || row['–ü—Ä–æ–¥–∞–∂—ñ (–º¬≤)'] || '0').toString().replace(',', '.')), 0);
            const totalR = r.reduce((sum, row) => sum + parseFloat((row['–í—Å—å–æ–≥–æ, –∫–≤ –º'] || row['–ü—Ä–æ–¥–∞–∂—ñ (–º¬≤)'] || '0').toString().replace(',', '.')), 0);
            const totalP = p.reduce((sum, row) => sum + parseFloat((row['–í—Å—å–æ–≥–æ, –∫–≤ –º'] || row['–ü—Ä–æ–¥–∞–∂—ñ (–º¬≤)'] || '0').toString().replace(',', '.')), 0);
            document.getElementById('analytics-content').innerHTML = `
                <table class="comparison-table">
                    <thead><tr><th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th><th>–ü—Ä–æ–¥–∞–∂—ñ (–∫–≤ –º)</th></tr></thead>
                    <tbody>
                        <tr><td>–ê–Ω–¥—Ä—ñ–π</td><td>${totalA.toLocaleString('uk-UA', {maximumFractionDigits: 3})}</td></tr>
                        <tr><td>–†–æ–º–∞–Ω</td><td>${totalR.toLocaleString('uk-UA', {maximumFractionDigits: 3})}</td></tr>
                        <tr><td>–ü–∞–≤–ª–æ</td><td>${totalP.toLocaleString('uk-UA', {maximumFractionDigits: 3})}</td></tr>
                    </tbody>
                </table>
            `;
        });
    }

    // –ü–ª–∞–Ω–∏ (—Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ü—ñ–ª–µ–π)
    function renderPlans() {
        fetchSheet('–ü–ª–∞–Ω–∏').then(data => {
            let html = '<table class="comparison-table"><thead><tr><th>–ú–µ–Ω–µ–¥–∂–µ—Ä</th><th>–¶—ñ–ª—å</th><th>–ü–ª–∞–Ω</th><th>–§–∞–∫—Ç</th><th>–í–∏–∫–æ–Ω–∞–Ω–Ω—è (%)</th></tr></thead><tbody>';
            data.forEach(row => {
                html += `<tr><td>${row['–ú–µ–Ω–µ–¥–∂–µ—Ä']||''}</td><td>${row['–¶—ñ–ª—å']||''}</td><td>${row['–ü–ª–∞–Ω']||''}</td><td>${row['–§–∞–∫—Ç']||''}</td><td>${row['–í–∏–∫–æ–Ω–∞–Ω–Ω—è']||''}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('plans-content').innerHTML = html;
        });
    }

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
    renderAllManagers();
    renderAnalytics();
    renderPlans();
    </script>
</body>
</html>