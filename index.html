<!DOCTYPE html>

<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Система обліку стендів та продажів</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }
        
        .tabs {
            display: flex;
            background: #ecf0f1;
            border-bottom: 3px solid #3498db;
        }
        
        .tab {
            flex: 1;
            padding: 15px 20px;
            background: #bdc3c7;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
            transform: translateY(-2px);
        }
        
        .tab:hover:not(.active) {
            background: #95a5a6;
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 25px;
            animation: fadeIn 0.5s ease-in-out;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .manager-info {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .manager-details h2 {
            margin: 0;
            font-size: 1.8em;
        }
        
        .manager-stats {
            display: flex;
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            display: block;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .goals-section {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .goals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .goal-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 4px solid #3498db;
        }
        
        .goal-title {
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .progress-bar {
            background: #ecf0f1;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .data-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            border-bottom: 2px solid #34495e;
        }
        
        .data-table td {
            padding: 8px;
            text-align: center;
            border-bottom: 1px solid #ecf0f1;
            transition: background 0.3s ease;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .shop-name {
            text-align: left !important;
            font-weight: 600;
            color: #2c3e50;
            background: #f8f9fa;
            border-left: 4px solid #3498db;
        }
        
        .address-cell {
            text-align: left !important;
            font-size: 11px;
            color: #7f8c8d;
            max-width: 200px;
        }
        
        .brand-cell {
            font-weight: 600;
            color: #2c3e50;
        }
        
        .sales-cell {
            font-weight: bold;
            color: #27ae60;
        }
        
        .comment-cell {
            text-align: left !important;
            font-size: 11px;
            color: #7f8c8d;
            max-width: 200px;
        }
        
        .total-row {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            font-weight: bold;
        }
        
        .total-row td {
            border-bottom: none;
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .analytics-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-top: 4px solid #3498db;
        }
        
        .analytics-card h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            font-size: 1.3em;
        }
        
        .chart-container {
            height: 200px;
            background: #f8f9fa;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-value {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .edit-btn {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s ease;
        }
        
        .edit-btn:hover {
            transform: translateY(-2px);
        }
        
        .add-btn {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            margin: 10px 0;
            transition: transform 0.2s ease;
        }
        
        .add-btn:hover {
            transform: translateY(-2px);
        }
        
        .region-badge {
            background: #e74c3c;
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .region-badge.kyiv { background: #3498db; }
        .region-badge.dnipro { background: #e74c3c; }
        .region-badge.west { background: #f39c12; }
        
        .brand-distribution {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .brand-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .brand-count {
            font-size: 1.5em;
            font-weight: bold;
            color: #3498db;
        }
        
        .brand-name {
            font-size: 0.9em;
            color: #7f8c8d;
        }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #ecf0f1;
        }
        
        .comparison-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
        }
        
        .comparison-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .performance-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .performance-high { background: #2ecc71; }
        .performance-medium { background: #f39c12; }
        .performance-low { background: #e74c3c; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏪 Система обліку стендів та продажів</h1>
            <p>Комплексна аналітика роботи з торговими точками</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('andrii')">👨‍💼 Андрій (Київ)</button>
            <button class="tab" onclick="showTab('roman')">👨‍💼 Роман (Дніпро)</button>
            <button class="tab" onclick="showTab('pavlo')">👨‍💼 Павло (Захід)</button>
            <button class="tab" onclick="showTab('analytics')">📊 Порівняльна аналітика</button>
            <button class="tab" onclick="showTab('plans')">🎯 Цілі та плани</button>
        </div>
        
        <div id="andrii" class="tab-content active">
            <div class="manager-info">
                <div class="manager-details">
                    <h2>👨‍💼 Андрій Вовнянко</h2>
                    <p><span class="region-badge kyiv">Київ та область</span></p>
                </div>
                <div class="manager-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="andrii-sales">0</span>
                        <span class="stat-label">Продажі (кв м)</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="andrii-avg">0</span>
                        <span class="stat-label">Середня ТТ</span>
                    </div>
                </div>
            </div>
            
            <div class="goals-section">
                <h3>🎯 Цілі на поточний місяць</h3>
                <div class="goals-grid" id="andrii-goals"></div>
            </div>
            
            <button class="add-btn" onclick="openAddSaleForm('andrii')">Додати продаж</button>
            <table class="data-table" id="andrii-table">
                <thead>
                    <tr>
                        <th>Торгова точка</th>
                        <th>Стенд</th>
                        <th>Продажі (кв м)</th>
                        <th>Дата</th>
                        <th>Коментар</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <h4>Облік стендів (матриця)</h4>
            <div id="andrii-stands-matrix"></div>
            <h4>Продажі (матриця)</h4>
            <div class="filter-row">
              <label>Місяць:
                <select class="month-select" data-manager="andrii"></select>
              </label>
              <label>Рік:
                <select class="year-select" data-manager="andrii"></select>
              </label>
            </div>
            <div id="andrii-sales-matrix"></div>
        </div>
        
        <div id="roman" class="tab-content">
            <div class="manager-info">
                <div class="manager-details">
                    <h2>👨‍💼 Роман</h2>
                    <p><span class="region-badge dnipro">Дніпро та область</span></p>
                </div>
                <div class="manager-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="roman-sales">0</span>
                        <span class="stat-label">Продажі (кв м)</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="roman-avg">0</span>
                        <span class="stat-label">Середня ТТ</span>
                    </div>
                </div>
            </div>
            <div class="goals-section">
                <h3>🎯 Цілі на поточний місяць</h3>
                <div class="goals-grid" id="roman-goals"></div>
            </div>
            <button class="add-btn" onclick="openAddSaleForm('roman')">Додати продаж</button>
            <table class="data-table" id="roman-table">
                <thead>
                    <tr>
                        <th>Торгова точка</th>
                        <th>Стенд</th>
                        <th>Продажі (кв м)</th>
                        <th>Дата</th>
                        <th>Коментар</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <h4>Облік стендів (матриця)</h4>
            <div id="roman-stands-matrix"></div>
            <h4>Продажі (матриця)</h4>
            <div class="filter-row">
              <label>Місяць:
                <select class="month-select" data-manager="roman"></select>
              </label>
              <label>Рік:
                <select class="year-select" data-manager="roman"></select>
              </label>
            </div>
            <div id="roman-sales-matrix"></div>
        </div>
        
        <div id="pavlo" class="tab-content">
            <div class="manager-info">
                <div class="manager-details">
                    <h2>👨‍💼 Павло</h2>
                    <p><span class="region-badge west">Західна Україна</span></p>
                </div>
                <div class="manager-stats">
                    <div class="stat-item">
                        <span class="stat-value" id="pavlo-sales">0</span>
                        <span class="stat-label">Продажі (кв м)</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-value" id="pavlo-avg">0</span>
                        <span class="stat-label">Середня ТТ</span>
                    </div>
                </div>
            </div>
            <div class="goals-section">
                <h3>🎯 Цілі на поточний місяць</h3>
                <div class="goals-grid" id="pavlo-goals"></div>
            </div>
            <button class="add-btn" onclick="openAddSaleForm('pavlo')">Додати продаж</button>
            <table class="data-table" id="pavlo-table">
                <thead>
                    <tr>
                        <th>Торгова точка</th>
                        <th>Стенд</th>
                        <th>Продажі (кв м)</th>
                        <th>Дата</th>
                        <th>Коментар</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
            <h4>Облік стендів (матриця)</h4>
            <div id="pavlo-stands-matrix"></div>
            <h4>Продажі (матриця)</h4>
            <div class="filter-row">
              <label>Місяць:
                <select class="month-select" data-manager="pavlo"></select>
              </label>
              <label>Рік:
                <select class="year-select" data-manager="pavlo"></select>
              </label>
            </div>
            <div id="pavlo-sales-matrix"></div>
        </div>
        
        <div id="analytics" class="tab-content">
            <h2>📊 Порівняльна аналітика</h2>
            <div id="analytics-content"></div>
        </div>
        
        <div id="plans" class="tab-content">
            <h2>🎯 Цілі та плани</h2>
            <div id="plans-content"></div>
        </div>
        
        <div id="modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); align-items:center; justify-content:center; z-index:1000;">
            <div style="background:white; padding:30px; border-radius:10px; min-width:300px; max-width:90vw;">
                <h3 id="modal-title">Додати продаж</h3>
                <form id="modal-form">
                    <div>
                        <label>Торгова точка:<br>
                            <select name="shop" id="modal-shop-select" required></select>
                        </label>
                    </div>
                    <div>
                        <label>Стенд:<br>
                            <select name="stand" id="modal-stand-select" required></select>
                        </label>
                    </div>
                    <div>
                        <label>Продажі (кв м):<br>
                            <input name="sales" type="number" step="0.001" required>
                        </label>
                    </div>
                    <div>
                        <label>Дата:<br>
                            <input name="date" type="date" required>
                        </label>
                    </div>
                    <div>
                        <label>Коментар:<br>
                            <input name="comment">
                        </label>
                    </div>
                    <div style="margin-top:15px; text-align:right;">
                        <button type="button" onclick="closeModal()">Скасувати</button>
                        <button type="submit">Зберегти</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbzd81nrC9ZPq-sz56rC7rGxnzJ4d3s_w543JeVSfQIcJYa73gAlWRhCaMi5vJ6oxieT/exec';

    const managerSheets = {
        andrii: {
            sales: 'Продажі Червень (Андрій)',
            stands: 'Облік стендів(Андрій)',
            goals: 'Плани',
            name: 'Андрій'
        },
        roman: {
            sales: 'Продажі Червень (Роман)',
            stands: 'Облік стендів(Роман)',
            goals: 'Плани',
            name: 'Роман'
        },
        pavlo: {
            sales: 'Продажі Червень (Павло)',
            stands: 'Облік стендів(Павло)',
            goals: 'Плани',
            name: 'Павло'
        }
    };

    async function fetchSheet(sheet) {
        const url = `${API_URL}?sheet=${encodeURIComponent(sheet)}`;
        const res = await fetch(url);
        return await res.json();
    }

    function parseStandsMatrix(data) {
        if (!data.length) return [];
        const columns = Object.keys(data[0]);
        const idxStart = columns.indexOf("Адреса") + 1;
        let idxEnd = columns.indexOf("Коментар");
        if (idxEnd === -1) idxEnd = columns.length;
        const standColumns = columns.slice(idxStart, idxEnd);

        const result = [];
        data.forEach(row => {
            const tt = (row["Назва ТТ"] || "").toLowerCase();
            if (
                !tt ||
                ["менеджер", "місяць", "торгова точка", "стенд", "продажі (м²)", "дата"].includes(tt)
            ) return;

            standColumns.forEach(stand => {
                const value = row[stand];
                if (value && value.toString().trim() !== '0' && value.toString().trim() !== '-' && value.toString().trim() !== '') {
                    result.push({
                        "Стенд": stand,
                        "ТТ": row["Назва ТТ"],
                        "Адреса": row["Адреса"],
                        "Кількість": value,
                        "Коментар": row["Коментар"] || ""
                    });
                }
            });
        });
        return result;
    }

    function renderStandsMatrix(manager, data) {
        if (!data.length) return;
        const columns = Object.keys(data[0]);
        const idxStart = columns.indexOf("Адреса") + 1;
        let idxEnd = columns.indexOf("Коментар");
        if (idxEnd === -1) idxEnd = columns.length;
        const standColumns = columns.slice(idxStart, idxEnd);

        // Підрахунок сум по кожному стенду
        const totals = {};
        standColumns.forEach(col => totals[col] = 0);

        let rowsHtml = '';
        data.forEach(row => {
            const tt = (row["Назва ТТ"] || "").toLowerCase();
            if (
                !tt ||
                ["менеджер", "місяць", "торгова точка", "стенд", "продажі (м²)", "дата"].includes(tt)
            ) return;
            rowsHtml += `<tr><td>${row["Назва ТТ"] || ""}</td><td>${row["Адреса"] || ""}</td>`;
            standColumns.forEach(col => {
                const val = Number(row[col]) || 0;
                totals[col] += val;
                rowsHtml += `<td>${row[col] || ""}</td>`;
            });
            rowsHtml += `<td>${row["Коментар"] || ""}</td></tr>`;
        });

        // Формуємо підсумковий рядок
        let totalsHtml = '<tr style="font-weight:bold;background:#e3f6ff;"><td colspan="2">Всього</td>';
        standColumns.forEach(col => totalsHtml += `<td>${totals[col]}</td>`);
        totalsHtml += '<td></td></tr>';

        // Формуємо всю таблицю
        let html = '<table class="data-table"><thead><tr>';
        html += '<th>Торгова точка</th><th>Адреса</th>';
        standColumns.forEach(col => html += `<th>${col}</th>`);
        html += '<th>Коментар</th></tr>';
        html += totalsHtml;
        html += '</thead><tbody>';
        html += rowsHtml;
        html += '</tbody></table>';

        document.getElementById(`${manager}-stands-matrix`).innerHTML = html;
    }

    function renderSalesMatrix(manager, data) {
        if (!data.length) return;
        console.log('Ключі колонок у data[0]:', Object.keys(data[0]));
        console.log('Перший рядок:', data[0]);
        const columns = Object.keys(data[0]);
        // Визначаємо індекси
        const idxStart = columns.indexOf("Tarkett: Express");
        let idxEnd = columns.indexOf("Номери накладних");
        if (idxEnd === -1) idxEnd = columns.length - 1;
        const standColumns = columns.slice(idxStart, idxEnd);

        // Підрахунок сум по кожній колонці (включаючи "Всього, кв м")
        const totals = {};
        ["Всього, кв м", ...standColumns].forEach(col => totals[col] = 0);

        let rowsHtml = '';
        data.forEach(row => {
            const tt = (row["Назва ТТ"] || "").toLowerCase().trim();
            if (!tt) return;
            rowsHtml += `<tr><td>${row["Назва ТТ"] || ""}</td>`;
            rowsHtml += `<td>${row["Всього, кв м"] || ""}</td>`;
            standColumns.forEach(col => {
                const val = Number(row[col]) || 0;
                totals[col] += val;
                rowsHtml += `<td>${row[col] || ""}</td>`;
            });
            rowsHtml += `<td>${row["Номери накладних"] || ""}</td></tr>`;
            totals["Всього, кв м"] += Number(row["Всього, кв м"]) || 0;
        });

        // Підсумковий рядок
        let totalsHtml = '<tr style="font-weight:bold;background:#e3f6ff;"><td>Всього</td>';
        totalsHtml += `<td>${totals["Всього, кв м"]}</td>`;
        standColumns.forEach(col => totalsHtml += `<td>${totals[col]}</td>`);
        totalsHtml += '<td></td></tr>';

        // Формуємо всю таблицю
        let html = '<table class="data-table"><thead><tr>';
        html += '<th>Назва ТТ</th><th>Всього, кв м</th>';
        standColumns.forEach(col => html += `<th>${col}</th>`);
        html += '<th>Номери накладних</th></tr>';
        html += totalsHtml;
        html += '</thead><tbody>';
        html += rowsHtml;
        html += '</tbody></table>';

        document.getElementById(`${manager}-sales-matrix`).innerHTML = html;
    }

    const months = [
      "Січень", "Лютий", "Березень", "Квітень", "Травень", "Червень",
      "Липень", "Серпень", "Вересень", "Жовтень", "Листопад", "Грудень"
    ];

    function fillMonthYearSelectors() {
      ['andrii', 'roman', 'pavlo'].forEach(manager => {
        const monthSel = document.querySelector(`.month-select[data-manager="${manager}"]`);
        const yearSel = document.querySelector(`.year-select[data-manager="${manager}"]`);
        if (!monthSel || !yearSel) return;
        monthSel.innerHTML = months.map((m, i) =>
          `<option value="${i+1}" ${i+1===new Date().getMonth()+1 ? 'selected' : ''}>${m}</option>`
        ).join('');
        const thisYear = new Date().getFullYear();
        yearSel.innerHTML = '';
        for (let y = thisYear; y >= thisYear-5; y--) {
          yearSel.innerHTML += `<option value="${y}" ${y===thisYear ? 'selected' : ''}>${y}</option>`;
        }
      });
    }
    fillMonthYearSelectors();

    function filterSalesByMonth(data, month, year) {
      return data.filter(row => {
        if (!row['Дата']) return false;
        let d;
        if (row['Дата'].includes('.')) {
          // DD.MM.YYYY
          const [day, mon, yr] = row['Дата'].split('.');
          d = new Date(`${yr}-${mon}-${day}`);
        } else {
          d = new Date(row['Дата']);
        }
        return d.getMonth() + 1 === month && d.getFullYear() === year;
      });
    }

    document.querySelectorAll('.month-select, .year-select').forEach(sel => {
      sel.addEventListener('change', function() {
        const manager = this.getAttribute('data-manager');
        renderManagerTab(manager, true); // true = оновити тільки продажі
      });
    });

    function renderManagerTab(manager, onlySales = false) {
      const sheets = managerSheets[manager];
      // Витягуємо обраний місяць/рік
      const monthSel = document.querySelector(`.month-select[data-manager="${manager}"]`);
      const yearSel = document.querySelector(`.year-select[data-manager="${manager}"]`);
      const month = monthSel ? Number(monthSel.value) : (new Date().getMonth() + 1);
      const year = yearSel ? Number(yearSel.value) : (new Date().getFullYear());

      fetchSheet(sheets.sales).then(data => {
        const filtered = filterSalesByMonth(data, month, year);
        const total = filtered.reduce((sum, row) => {
          const val = parseFloat((row['Всього, кв м'] || row['Продажі (м²)'] || '0').toString().replace(',', '.'));
          return sum + (isNaN(val) ? 0 : val);
        }, 0);
        const roundedTotal = total.toFixed(3);
        document.getElementById(`${manager}-sales`).textContent = roundedTotal;
        const avg = filtered.length ? (total / filtered.length) : 0;
        document.getElementById(`${manager}-avg`).textContent = avg.toLocaleString('uk-UA', {maximumFractionDigits: 3});
        // Таблиця продажів
        const tbody = document.querySelector(`#${manager}-table tbody`);
        tbody.innerHTML = '';
        filtered.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${row['Назва ТТ'] || row['Торгова точка'] || ''}</td>
            <td>${row['Стенд'] || ''}</td>
            <td>${row['Всього, кв м'] || row['Продажі (м²)'] || ''}</td>
            <td>${row['Дата'] ? new Date(row['Дата']).toLocaleDateString('uk-UA') : ''}</td>
            <td>${row['Коментар'] || ''}</td>
          `;
          tbody.appendChild(tr);
        });
        renderSalesMatrix(manager, filtered);
        console.log('filtered sales:', filtered);
      });

      if (!onlySales) {
        // Стенди
        fetchSheet(sheets.stands).then(data => {
          renderStandsMatrix(manager, data);
        });
        // Цілі
        fetchSheet(sheets.goals).then(data => {
          const goals = data.filter(row => row['Менеджер'] === sheets.name);
          const grid = document.getElementById(`${manager}-goals`);
          grid.innerHTML = '';
          goals.forEach(goal => {
            const div = document.createElement('div');
            div.className = 'goal-card';
            div.innerHTML = `
              <div class="goal-title">${goal['Ціль'] || 'Продажі'}</div>
              <div class="progress-bar"><div class="progress-fill" style="width:${goal['Виконання']||'0'}%">${goal['Виконання']||'0'}%</div></div>
              <div>${goal['Факт']||'0'} / ${goal['План']||'0'}</div>
            `;
            grid.appendChild(div);
          });
        });
      }
    }

    function renderAllManagers() {
      renderManagerTab('andrii');
      renderManagerTab('roman');
      renderManagerTab('pavlo');
    }

    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
    }

    // Модальне вікно для додавання продажу
    async function openAddSaleForm(manager) {
        document.getElementById('modal').style.display = 'flex';
        document.getElementById('modal-title').textContent = 'Додати продаж';
        const form = document.getElementById('modal-form');

        // 1. Підтягуємо торгові точки та стенди
        const standsData = await fetchSheet(managerSheets[manager].stands);

        // Унікальні торгові точки
        const shops = Array.from(new Set(
          standsData
            .map(row => row['Назва ТТ'])
            .filter(Boolean)
        ));

        // Унікальні стенди (по всіх колонках після "Адреса" і до "Коментар")
        const columns = standsData.length ? Object.keys(standsData[0]) : [];
        const idxStart = columns.indexOf("Адреса") + 1;
        let idxEnd = columns.indexOf("Коментар");
        if (idxEnd === -1) idxEnd = columns.length;
        const standNames = columns.slice(idxStart, idxEnd);

        // Заповнюємо селектори
        const shopSelect = document.getElementById('modal-shop-select');
        const standSelect = document.getElementById('modal-stand-select');
        console.log('shopSelect:', shopSelect, 'standSelect:', standSelect);
        shopSelect.innerHTML = shops.map(shop => `<option value="${shop}">${shop}</option>`).join('');

        standSelect.innerHTML = standNames.map(stand => `<option value="${stand}">${stand}</option>`).join('');

        console.log('shops:', shops);
        console.log('standNames:', standNames);

        // 2. Обробка сабміту
        form.onsubmit = async function(e) {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(form).entries());
            // Формуємо об'єкт для Google Sheets
            const row = {
                'Торгова точка': data.shop,
                'Стенд': data.stand,
                'Продажі (м²)': data.sales,
                'Дата': data.date,
                'Коментар': data.comment
            };
            await fetch(API_URL, {
                method: 'POST',
                body: JSON.stringify({sheet: managerSheets[manager].sales, data: row}),
                headers: {'Content-Type': 'application/json'}
            });
            closeModal();
            renderManagerTab(manager);
        };
    }
    function closeModal() {
        document.getElementById('modal').style.display = 'none';
    }

    // Аналітика (загальна)
    function renderAnalytics() {
        // Порівняння продажів по менеджерах
        Promise.all([
            fetchSheet(managerSheets.andrii.sales),
            fetchSheet(managerSheets.roman.sales),
            fetchSheet(managerSheets.pavlo.sales)
        ]).then(([a, r, p]) => {
            const totalA = a.reduce((sum, row) => sum + parseFloat((row['Всього, кв м'] || row['Продажі (м²)'] || '0').toString().replace(',', '.')), 0);
            const totalR = r.reduce((sum, row) => sum + parseFloat((row['Всього, кв м'] || row['Продажі (м²)'] || '0').toString().replace(',', '.')), 0);
            const totalP = p.reduce((sum, row) => sum + parseFloat((row['Всього, кв м'] || row['Продажі (м²)'] || '0').toString().replace(',', '.')), 0);
            document.getElementById('analytics-content').innerHTML = `
                <table class="comparison-table">
                    <thead><tr><th>Менеджер</th><th>Продажі (кв м)</th></tr></thead>
                    <tbody>
                        <tr><td>Андрій</td><td>${totalA.toLocaleString('uk-UA', {maximumFractionDigits: 3})}</td></tr>
                        <tr><td>Роман</td><td>${totalR.toLocaleString('uk-UA', {maximumFractionDigits: 3})}</td></tr>
                        <tr><td>Павло</td><td>${totalP.toLocaleString('uk-UA', {maximumFractionDigits: 3})}</td></tr>
                    </tbody>
                </table>
            `;
        });
    }

    // Плани (редагування цілей)
    function renderPlans() {
        fetchSheet('Плани').then(data => {
            let html = '<table class="comparison-table"><thead><tr><th>Менеджер</th><th>Ціль</th><th>План</th><th>Факт</th><th>Виконання (%)</th></tr></thead><tbody>';
            data.forEach(row => {
                html += `<tr><td>${row['Менеджер']||''}</td><td>${row['Ціль']||''}</td><td>${row['План']||''}</td><td>${row['Факт']||''}</td><td>${row['Виконання']||''}</td></tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('plans-content').innerHTML = html;
        });
    }

    // Ініціалізація
    renderAllManagers();
    renderAnalytics();
    renderPlans();
    </script>
</body>
</html>